<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>前端原生使用单点登录(协议HTTP版)-DEMO</title>
    <script src="jquery-3.5.1.min.js"></script>
    <script src="config.js"></script>
    <script>


        function test() {
            $.ajax({
                url: backendDemoUrl + "/greet",
                data: JSON.stringify({"name": 'jenny'}),
                type: "POST",
                contentType: "application/json",
                beforeSend:beforeSend, //发送请求
                dataType: "json",
                success: function(data) {
                  console.log(data);
                },
                error: function(res) {
                    // 401 602
                    console.log(res);
                    if (res.status == 401 || res.status == 602) {
                        //获取ticket
                        $.ajax({
                            url: ticketShareAgentUrl + "/getTicket",
                            async: false, //同步
                            // data: JSON.stringify({"name": 'jenny'}),
                            type: "GET",
                            crossDomain: true,
                            contentType: "application/json",
                            // beforeSend:beforeSend, //发送请求
                            dataType: "json",
                            success: function(data) {
                                if (data.value == null) {
                                    //调用登录页面登录
                                    alert("未获取到共享ticket,将跳转至登录页面");
                                    window.location.href = "login.html";
                                } else {
                                    alert("使用这个token:" + data.value);
                                    $.ajax({
                                        url: backendDemoUrl + "/sso_mix_verify",
                                        type: "GET",
                                        contentType: "application/json",
                                        dataType: "json",
                                        beforeSend: function(xhr) {
                                            xhr.setRequestHeader("Authorization", data.value);
                                        },
                                        success: function(data) {
                                            console.log(data);
                                            localStorage.setItem('ISCAS-SSO-MIX-TOKEN' + ";" + backendDemoUrl, data.value);
                                            alert("验证成功");
                                            test();
                                        },
                                        error: function(res) {
                                            console.log(res);
                                            // alert("");
                                        }
                                    });
                                }
                            }
                        });
                    }
                    if (res.status == 604) {
                        alert("共享服务的ticket无效，请重新登录");
                        window.location.href = "login.html";
                    }
                }
            });

        }

        function beforeSend(request) {
            let ssoMixToken = localStorage.getItem('ISCAS-SSO-MIX-TOKEN' + ";" + backendDemoUrl);
            if (ssoMixToken == null) {
                //localStorage存储的token为空
                //尝试从ticket共享服务获取token
                getTicket(request);
            } else {
                //设置请求头
                request.setRequestHeader("Authorization", ssoMixToken);
            }
        }

        function getTicket(request) {
            $.ajax({
                url: ticketShareAgentUrl + "/getTicket",
                async: false, //同步
                // data: JSON.stringify({"name": 'jenny'}),
                type: "GET",
                crossDomain: true,
                contentType: "application/json",
                // beforeSend:beforeSend, //发送请求
                dataType: "json",
                success: function(data) {
                    if (data.value == null) {
                        request.abort();
                        //调用登录页面登录
                        alert("未获取到共享ticket,将跳转至登录页面");
                        window.location.href = "login.html";
                    } else {
                        request.setRequestHeader("Authorization", data.value);
                    }
                },
                error: function(xhr) {
                    request.abort();
                }
            });
        }


    </script>
</head>
<body>
    <input type = "button" value="我是一个测试按钮" onclick="test();"/>
</body>
</html>